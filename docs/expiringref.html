<!DOCTYPE html><html><head><title>FS2-ES: ExpiringRef</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ryan Peters" /><meta name="description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="og:image" content="/sloshy.github.io/img/poster.png" /><meta name="image" property="og:image" content="/sloshy.github.io/img/poster.png" /><meta name="og:title" content="FS2-ES: ExpiringRef" /><meta name="title" property="og:title" content="FS2-ES: ExpiringRef" /><meta name="og:site_name" content="FS2-ES" /><meta name="og:url" content="https://sloshy.github.io/fs2-es/" /><meta name="og:type" content="website" /><meta name="og:description" content="A small library for event-driven state and event-sourcing for FS2" /><link rel="icon" type="image/png" href="/sloshy.github.io/img/favicon.png" /><meta name="twitter:title" content="FS2-ES: ExpiringRef" /><meta name="twitter:image" content="/sloshy.github.io/img/poster.png" /><meta name="twitter:description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@LiquidSloshalot" /><link rel="icon" type="image/png" sizes="16x16" href="/sloshy.github.io/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/sloshy.github.io/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/sloshy.github.io/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/sloshy.github.io/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/sloshy.github.io/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/sloshy.github.io/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/sloshy.github.io/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/sloshy.github.io/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/sloshy.github.io/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/sloshy.github.io/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/sloshy.github.io/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/sloshy.github.io/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/sloshy.github.io/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/sloshy.github.io/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/sloshy.github.io/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/sloshy.github.io/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/sloshy.github.io/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/sloshy.github.io/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/sloshy.github.io/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/sloshy.github.io/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/sloshy.github.io/highlight/styles/vs.css" /><link rel="stylesheet" href="/sloshy.github.io/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/sloshy.github.io/" class="brand"><div class="brand-wrapper"></div><span>FS2-ES</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/" title="Intro" class="">Intro</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/eventstate" title="EventState" class="">EventState</a></div> <div class="sidebar-nav-item active "><a href="/sloshy.github.io/docs/expiringref" title="ExpiringRef" class="active">ExpiringRef</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/eventstatecache" title="EventStateCache" class="">EventStateCache</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/mapref" title="MapRef" class="">MapRef</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/deferredmap" title="DeferredMap" class="">DeferredMap</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/testing" title="Testing" class="">Testing</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="sloshy" data-github-repo="fs2-es"><div class="content-wrapper"><section><h1 id="expiringref">ExpiringRef</h1>
<p>Not directly related to events, but a useful primitive nonetheless, an <code class="language-plaintext highlighter-rouge">ExpiringRef</code> is a concurrently available value that expires after a certain period of time.
When using event sourcing in particular, it can be helpful to “cache” event state in memory so that your application is not continuously reading from the event log every time it needs the latest state for something.
This abstraction uses an internal timer that resets after each use so that lifetime management of your state is automated.</p>

<p>Here is a simple example:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">dev.rpeters.fs2.es.data.ExpiringRef</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.global</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">global</span><span class="o">)</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="n">global</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">timedRef</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">res</span> <span class="k">&lt;-</span> <span class="nc">ExpiringRef</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">timed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mf">2.</span><span class="n">seconds</span><span class="o">)</span>
  <span class="n">firstResult</span> <span class="k">&lt;-</span> <span class="nv">res</span><span class="o">.</span><span class="py">use</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">pure</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">res</span><span class="o">.</span><span class="py">expired</span>
  <span class="n">secondResult</span> <span class="k">&lt;-</span> <span class="nv">res</span><span class="o">.</span><span class="py">use</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">pure</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="o">))</span>
<span class="o">}</span> <span class="nf">yield</span> <span class="o">(</span><span class="n">firstResult</span><span class="o">,</span> <span class="n">secondResult</span><span class="o">)</span>
</code></pre></div></div>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">timedRef</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res0: (Option[Int], Option[Int]) = (Some(value = 2), None)</span>
</code></pre></div></div>

<p>There is also a variant <code class="language-plaintext highlighter-rouge">ExpiringRef[F].uses</code> that lets you specify a maximum number of uses, but you may find the timed variant to be more practical for event sourcing.</p>
</section></div></div></div></div><script src="/sloshy.github.io/highlight/highlight.pack.js"></script><script src="/sloshy.github.io/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'fs2-es/community'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/sloshy.github.io/js/search.js"></script><script src="/sloshy.github.io/js/docs.js"></script></body></html>