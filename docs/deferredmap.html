<!DOCTYPE html><html><head><title>FS2-ES: DeferredMap</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ryan Peters" /><meta name="description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="og:image" content="/fs2-es/img/poster.png" /><meta name="image" property="og:image" content="/fs2-es/img/poster.png" /><meta name="og:title" content="FS2-ES: DeferredMap" /><meta name="title" property="og:title" content="FS2-ES: DeferredMap" /><meta name="og:site_name" content="FS2-ES" /><meta name="og:url" content="https://sloshy.github.io/fs2-es/" /><meta name="og:type" content="website" /><meta name="og:description" content="A small library for event-driven state and event-sourcing for FS2" /><link rel="icon" type="image/png" href="/fs2-es/img/favicon.png" /><meta name="twitter:title" content="FS2-ES: DeferredMap" /><meta name="twitter:image" content="/fs2-es/img/poster.png" /><meta name="twitter:description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@LiquidSloshalot" /><link rel="icon" type="image/png" sizes="16x16" href="/fs2-es/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/fs2-es/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/fs2-es/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/fs2-es/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/fs2-es/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/fs2-es/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/fs2-es/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/fs2-es/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/fs2-es/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/fs2-es/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/fs2-es/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/fs2-es/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/fs2-es/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/fs2-es/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/fs2-es/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/fs2-es/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/fs2-es/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/fs2-es/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/fs2-es/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/fs2-es/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/fs2-es/highlight/styles/vs.css" /><link rel="stylesheet" href="/fs2-es/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/fs2-es/" class="brand"><div class="brand-wrapper"></div><span>FS2-ES</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/" title="Intro" class="">Intro</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/eventstate/" title="EventState" class="">EventState</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/expiringref/" title="ExpiringRef" class="">ExpiringRef</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/eventstatecache/" title="EventStateCache" class="">EventStateCache</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/mapref/" title="MapRef" class="">MapRef</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/deferredmap/" title="DeferredMap" class="">DeferredMap</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/testing/" title="Testing" class="">Testing</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="sloshy" data-github-repo="fs2-es"><div class="content-wrapper"><section><h1 id="deferredmap">DeferredMap</h1>
<p>A <code class="language-plaintext highlighter-rouge">DeferredMap</code> is a concurrent <code class="language-plaintext highlighter-rouge">MapRef</code> that is specifically optimized for awaiting asynchronous values that may not have completed yet.
It is used internally by <code class="language-plaintext highlighter-rouge">EventStateCache</code> to keep track of what resources are already being awaited, so you do not duplicate requests.</p>

<p>Hereâ€™s a brief example of how you can use it, for awaiting a specific concurrent job to finish, by-key:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Deferred</span>
<span class="k">import</span> <span class="nn">dev.rpeters.fs2.es.data.DeferredMap</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.global</span>

<span class="c1">//Needed implicits for the examples here</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">global</span><span class="o">)</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span><span class="k">:</span> <span class="kt">Timer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="n">global</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">example</span> <span class="k">=</span> <span class="nc">DeferredMap</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">].</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">dmap</span> <span class="k">=&gt;</span>
  <span class="c1">//Helper function to complete a job concurrently after three seconds</span>
  <span class="k">def</span> <span class="nf">completeJobAfter3s</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">d</span> <span class="k">&lt;-</span> <span class="nc">Deferred</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">String</span><span class="o">]</span> <span class="c1">//Create our async result that has not finished yet</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">dmap</span><span class="o">.</span><span class="py">add</span><span class="o">(</span><span class="n">key</span><span class="o">)(</span><span class="n">d</span><span class="o">)</span> <span class="c1">//Add it to the map</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">timer</span><span class="o">.</span><span class="py">sleep</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">d</span><span class="o">.</span><span class="py">complete</span><span class="o">(</span><span class="s">"success"</span><span class="o">)).</span><span class="py">start</span> <span class="c1">//Complete it asynchronously</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
  
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">completeJobAfter3s</span><span class="o">(</span><span class="s">"job1"</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">completeJobAfter3s</span><span class="o">(</span><span class="s">"job2"</span><span class="o">)</span>
    <span class="n">res1</span> <span class="k">&lt;-</span> <span class="nv">dmap</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="s">"job1"</span><span class="o">)</span>
    <span class="n">res2</span> <span class="k">&lt;-</span> <span class="nv">dmap</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="s">"job2"</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">(</span><span class="n">res1</span><span class="o">,</span> <span class="n">res2</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">example</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res0: (String, String) = ("success", "success")</span>
</code></pre></div></div>

<p>The API has a lot of options available, including checking whether a value is being awaited as well as additional helper methods if you want the semantics of <code class="language-plaintext highlighter-rouge">TryableDeferred</code> instead.
With a <code class="language-plaintext highlighter-rouge">TryableDeferredMap</code>, you can check if a value has been completed as well as conditionally delete values based on completion status.</p>

<p><strong>BE ADVISED:</strong> This is a rather low-level concurrency tool and you will want to thoroughly test your usage of this in order to not leak anything.
Always be sure to delete values that have completed after some period of time, or make sure they expire with <code class="language-plaintext highlighter-rouge">ExpiringRef</code>.</p>
</section></div></div></div></div><script src="/fs2-es/highlight/highlight.pack.js"></script><script src="/fs2-es/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'fs2-es/community'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/fs2-es/js/search.js"></script><script src="/fs2-es/js/docs.js"></script></body></html>