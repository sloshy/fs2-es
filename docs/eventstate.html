<!DOCTYPE html><html><head><title>FS2-ES: EventState</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ryan Peters" /><meta name="description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="og:image" content="/sloshy.github.io/img/poster.png" /><meta name="image" property="og:image" content="/sloshy.github.io/img/poster.png" /><meta name="og:title" content="FS2-ES: EventState" /><meta name="title" property="og:title" content="FS2-ES: EventState" /><meta name="og:site_name" content="FS2-ES" /><meta name="og:url" content="https://sloshy.github.io/fs2-es/" /><meta name="og:type" content="website" /><meta name="og:description" content="A small library for event-driven state and event-sourcing for FS2" /><link rel="icon" type="image/png" href="/sloshy.github.io/img/favicon.png" /><meta name="twitter:title" content="FS2-ES: EventState" /><meta name="twitter:image" content="/sloshy.github.io/img/poster.png" /><meta name="twitter:description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@LiquidSloshalot" /><link rel="icon" type="image/png" sizes="16x16" href="/sloshy.github.io/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/sloshy.github.io/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/sloshy.github.io/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/sloshy.github.io/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/sloshy.github.io/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/sloshy.github.io/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/sloshy.github.io/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/sloshy.github.io/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/sloshy.github.io/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/sloshy.github.io/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/sloshy.github.io/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/sloshy.github.io/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/sloshy.github.io/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/sloshy.github.io/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/sloshy.github.io/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/sloshy.github.io/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/sloshy.github.io/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/sloshy.github.io/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/sloshy.github.io/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/sloshy.github.io/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/sloshy.github.io/highlight/styles/vs.css" /><link rel="stylesheet" href="/sloshy.github.io/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/sloshy.github.io/" class="brand"><div class="brand-wrapper"></div><span>FS2-ES</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/" title="Intro" class="">Intro</a></div> <div class="sidebar-nav-item active "><a href="/sloshy.github.io/docs/eventstate" title="EventState" class="active">EventState</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/expiringref" title="ExpiringRef" class="">ExpiringRef</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/eventstatecache" title="EventStateCache" class="">EventStateCache</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/mapref" title="MapRef" class="">MapRef</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/deferredmap" title="DeferredMap" class="">DeferredMap</a></div> <div class="sidebar-nav-item  "><a href="/sloshy.github.io/docs/testing" title="Testing" class="">Testing</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="sloshy" data-github-repo="fs2-es"><div class="content-wrapper"><section><h1 id="eventstate">EventState</h1>

<p>An <code class="language-plaintext highlighter-rouge">EventState</code> is a common abstraction to help you manage best practices for dealing with event-sourced state.
It can only be created with an initial value, and optionally a stream of events to “rehydrate” it by folding over them.</p>

<p>Example for only initial state:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">dev.rpeters.fs2.es.EventState</span>

<span class="k">val</span> <span class="nv">initialEventState</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">es</span> <span class="k">&lt;-</span> <span class="nc">EventState</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">initial</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">1</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">es</span><span class="o">.</span><span class="py">doNext</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="n">result</span> <span class="k">&lt;-</span> <span class="nv">es</span><span class="o">.</span><span class="py">get</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></div>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">initialEventState</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res0: Int = 2</span>
</code></pre></div></div>

<p>Example for rehydrating state:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.Stream</span>

<span class="k">val</span> <span class="nv">eventState</span> <span class="k">=</span> <span class="nc">EventState</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">initial</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">1</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">hydratedState</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">es</span> <span class="k">&lt;-</span> <span class="n">eventState</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">es</span><span class="o">.</span><span class="py">hydrate</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
  <span class="n">result</span> <span class="k">&lt;-</span> <span class="nv">es</span><span class="o">.</span><span class="py">get</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></div>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">hydratedState</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res1: Int = 2</span>
</code></pre></div></div>

<p>The only way to change a value in an <code class="language-plaintext highlighter-rouge">EventState</code> is to supply it manually to <code class="language-plaintext highlighter-rouge">doNext</code> or supply a hydrating stream of events.
In this way, an <code class="language-plaintext highlighter-rouge">EventState</code> is basically just a small wrapper around a <code class="language-plaintext highlighter-rouge">cats.effect.concurrent.Ref</code> that enforces an event-based access pattern.</p>

<p>You can also “hook up” a stream of events to an <code class="language-plaintext highlighter-rouge">EventState</code> to hydrate it and get a stream of the resulting states back:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">hookedUpStream</span> <span class="k">=</span> <span class="nc">EventState</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">initial</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">1</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">es</span> <span class="k">=&gt;</span>
  <span class="nc">Stream</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="nv">es</span><span class="o">.</span><span class="py">hookup</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">hookedUpStream</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res2: List[Int] = List(2, 3, 4)</span>
</code></pre></div></div>

<p>When using <code class="language-plaintext highlighter-rouge">hookup</code>, if you only have a single event stream going into your <code class="language-plaintext highlighter-rouge">EventState</code> then the resulting stream is guaranteed to have all possible state changes.</p>

<h3 id="signallingeventstate">SignallingEventState</h3>
<p>FS2 has some useful concurrency primitives in the form of <code class="language-plaintext highlighter-rouge">SignallingRef</code>s and <code class="language-plaintext highlighter-rouge">Topic</code>s, among others.
<code class="language-plaintext highlighter-rouge">SignallingRef</code> is useful when you want to use a variable as a signal where you continuously want the latest state change.
<code class="language-plaintext highlighter-rouge">SignallingEventState</code> is similar in that it has properties just like a <code class="language-plaintext highlighter-rouge">SignallingRef</code> but it also allows you to continuously stream state changes from it.
In particular, the following two methods are available:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">continuous</code> - Get a stream that continuously emits the latest state at the time</li>
  <li><code class="language-plaintext highlighter-rouge">discrete</code> - Get a stream of the latest state values, but only when the new state value is distinct from the previous value</li>
</ul>

<p>You should be aware that <strong>you are not guaranteed every single state change using these methods</strong>.
It is equivallent to repeatedly calling <code class="language-plaintext highlighter-rouge">get</code> and maybe doing some stateful filtering after.
If you actually want every single resulting state, you can use a single input stream with the <code class="language-plaintext highlighter-rouge">hookup</code> pipe.
Or, you can use <code class="language-plaintext highlighter-rouge">EventStateTopic</code> and subscribe.</p>

<h3 id="eventstatetopic">EventStateTopic</h3>
<p><code class="language-plaintext highlighter-rouge">EventStateTopic</code> is a variant of <code class="language-plaintext highlighter-rouge">EventState</code> that allows you to subscribe to all new state changes, just like an FS2 <code class="language-plaintext highlighter-rouge">Topic</code>.
It has a new method <code class="language-plaintext highlighter-rouge">subscribe</code> that returns a stream of all state changes from the moment of subscription, beginning with its current value.
You can also <code class="language-plaintext highlighter-rouge">hookupAndSubscribe</code> which will concurrently apply all events from the current stream, as well as subscribe and return all events, including ones not from the input stream.
This can be very useful if you have multiple spots where you want to “listen for” new state changes and get all of them, instead of just the latest one.
The downside of doing this approach is it is less efficient, as every single state change must be processed instead of just the latest one available, but sometimes that is the exact semantic that you want.</p>

<p>If you are debugging, look into <code class="language-plaintext highlighter-rouge">ReplayableEventState</code> from the testing package, which is based on <code class="language-plaintext highlighter-rouge">EventStateTopic</code>.</p>
</section></div></div></div></div><script src="/sloshy.github.io/highlight/highlight.pack.js"></script><script src="/sloshy.github.io/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'fs2-es/community'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/sloshy.github.io/js/search.js"></script><script src="/sloshy.github.io/js/docs.js"></script></body></html>