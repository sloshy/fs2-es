<!DOCTYPE html><html><head><title>FS2-ES: EventStateCache</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ryan Peters" /><meta name="description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="og:image" content="/fs2-es/img/poster.png" /><meta name="image" property="og:image" content="/fs2-es/img/poster.png" /><meta name="og:title" content="FS2-ES: EventStateCache" /><meta name="title" property="og:title" content="FS2-ES: EventStateCache" /><meta name="og:site_name" content="FS2-ES" /><meta name="og:url" content="https://sloshy.github.io/fs2-es/" /><meta name="og:type" content="website" /><meta name="og:description" content="A small library for event-driven state and event-sourcing for FS2" /><link rel="icon" type="image/png" href="/fs2-es/img/favicon.png" /><meta name="twitter:title" content="FS2-ES: EventStateCache" /><meta name="twitter:image" content="/fs2-es/img/poster.png" /><meta name="twitter:description" content="A small library for event-driven state and event-sourcing for FS2" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@LiquidSloshalot" /><link rel="icon" type="image/png" sizes="16x16" href="/fs2-es/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/fs2-es/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/fs2-es/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/fs2-es/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/fs2-es/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/fs2-es/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/fs2-es/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/fs2-es/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/fs2-es/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/fs2-es/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/fs2-es/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/fs2-es/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/fs2-es/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/fs2-es/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/fs2-es/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/fs2-es/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/fs2-es/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/fs2-es/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/fs2-es/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/fs2-es/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/fs2-es/highlight/styles/vs.css" /><link rel="stylesheet" href="/fs2-es/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/fs2-es/" class="brand"><div class="brand-wrapper"></div><span>FS2-ES</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/" title="Intro" class="">Intro</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/eventstate/" title="EventState" class="">EventState</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/expiringref/" title="ExpiringRef" class="">ExpiringRef</a></div> <div class="sidebar-nav-item active "><a href="/fs2-es/docs/eventstatecache/" title="EventStateCache" class="active">EventStateCache</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/mapref/" title="MapRef" class="">MapRef</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/deferredmap/" title="DeferredMap" class="">DeferredMap</a></div> <div class="sidebar-nav-item  "><a href="/fs2-es/docs/testing/" title="Testing" class="">Testing</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/sloshy/fs2-es" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="sloshy" data-github-repo="fs2-es"><div class="content-wrapper"><section><h1 id="eventstatecache">EventStateCache</h1>
<p>Now that we have abstractions for both event-sourced state and timed lifetime management, we can put the two together and automatically manage the lifetimes of <code class="language-plaintext highlighter-rouge">EventState</code> with <code class="language-plaintext highlighter-rouge">EventStateCache</code>.</p>

<p><code class="language-plaintext highlighter-rouge">EventStateCache</code> acts as a repository interface for generic event-sourced state.
It works similarly to a concurrent <code class="language-plaintext highlighter-rouge">Map</code> with each one of your <code class="language-plaintext highlighter-rouge">EventState</code>s held behind a key.
What makes <code class="language-plaintext highlighter-rouge">EventStateCache</code> special is that it understands how to create new states, read them from your event log, and manage their lifetimes for efficiency.</p>

<p>To create an <code class="language-plaintext highlighter-rouge">EventStateCache</code>, you need several functions and values defined that you plug into it.
Here are all of the parameters necessary, with description:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.Applicative</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">dev.rpeters.fs2.es.EventStateCache</span>
<span class="k">import</span> <span class="nn">fs2.Stream</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="c1">// Our event-sourced state. Each user has a name and a point value.</span>
<span class="c1">// We will be incrementing the user's points through events keyed to that user.</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">points</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">def</span> <span class="nf">fakeEventLog</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>

<span class="c1">// Function #1 - Defines how you create an "initial state" given a key.</span>
<span class="c1">// Don't worry about data that is not contained within the key at this stage.</span>
<span class="c1">// Those should be modifiable as events - remember, every single change to state should be an event.</span>
<span class="k">def</span> <span class="nf">initializer</span><span class="o">(</span><span class="n">k</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nc">User</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>

<span class="c1">// Function #2 - Defines how you restore state by reading in events by-key.</span>
<span class="c1">// In a real application this will likely be a query or reading from a file/stream/topic and filtering by key.</span>
<span class="k">def</span> <span class="nf">keyHydrator</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">k</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nf">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="s">"ExistingUser"</span><span class="o">)</span> <span class="n">fakeEventLog</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">else</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">empty</span>

<span class="c1">// Function #3 - Defines how you apply event to state.</span>
<span class="c1">// This is exactly the same as the function used when creating an `EventState` manually.</span>
<span class="k">def</span> <span class="nf">eventProcessor</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">state</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nv">state</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">points</span> <span class="k">=</span> <span class="nv">state</span><span class="o">.</span><span class="py">points</span> <span class="o">+</span> <span class="n">event</span><span class="o">)</span>

<span class="c1">// Function #4 - An optional function to check that state for a given key already exists in your event log.</span>
<span class="c1">// By default, this function is defined as testing that your `keyHydrator` function returns at least one event.</span>
<span class="c1">// If you define this function, you can provide a more optimized way to check that a key already exists in your event log.</span>
<span class="c1">// You can also disable the functionality entirely by returning `false`.</span>
<span class="k">def</span> <span class="nf">existenceCheck</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Applicative</span><span class="o">](</span><span class="n">k</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="nf">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="s">"ExistingUser"</span><span class="o">)</span> <span class="nc">Applicative</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">pure</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="k">else</span> <span class="nc">Applicative</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">pure</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>

<span class="c1">// Lastly we need a time-to-live duration for all states.</span>
<span class="k">val</span> <span class="nv">ttl</span> <span class="k">=</span> <span class="mf">2.</span><span class="n">minutes</span>
</code></pre></div></div>

<p>Finally, we can create an <code class="language-plaintext highlighter-rouge">EventStateCache</code> as follows:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">cacheF</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">EventStateCache</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">String</span>, <span class="kt">Int</span>, <span class="kt">User</span><span class="o">]]</span> <span class="k">=</span> 
  <span class="nc">EventStateCache</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">rehydrating</span><span class="o">(</span><span class="n">initializer</span><span class="o">)(</span><span class="n">keyHydrator</span><span class="o">[</span><span class="kt">IO</span><span class="o">])(</span><span class="n">eventProcessor</span><span class="o">)(</span><span class="n">ttl</span><span class="o">,</span> <span class="n">existenceCheck</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span>
</code></pre></div></div>

<p>Lets use this as a building block to write a basic event-sourced program:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.Pure</span>

<span class="c1">// An event type we can use to help initialize state for users.</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">UserCreatedEvent</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">usersToCreate</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Pure</span>, <span class="kt">UserCreatedEvent</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">(</span><span class="s">"FirstUser"</span><span class="o">,</span> <span class="s">"SecondUser"</span><span class="o">,</span> <span class="s">"ThirdUser"</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nc">UserCreatedEvent</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">fullProgram</span> <span class="k">=</span> <span class="nv">cacheF</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">cache</span> <span class="k">=&gt;</span>
  
  <span class="c1">// Because our existence check will fail for these, it should initialize these three with 0 points.</span>
  <span class="k">val</span> <span class="nv">initializeNewUsers</span> <span class="k">=</span> <span class="nv">usersToCreate</span><span class="o">.</span><span class="py">evalTap</span><span class="o">(</span><span class="n">u</span> <span class="k">=&gt;</span> <span class="nv">cache</span><span class="o">.</span><span class="py">add</span><span class="o">(</span><span class="nv">u</span><span class="o">.</span><span class="py">name</span><span class="o">)).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
  
  <span class="c1">// Our hydrate function will be used when we call `.use` on our cache.</span>
  <span class="k">val</span> <span class="nv">getExistingUser</span> <span class="k">=</span> <span class="nv">cache</span><span class="o">.</span><span class="py">use</span><span class="o">(</span><span class="s">"ExistingUser"</span><span class="o">)(</span><span class="n">es</span> <span class="k">=&gt;</span> <span class="nv">es</span><span class="o">.</span><span class="py">get</span><span class="o">)</span>

  <span class="c1">// We'll create a stream that gives all users 5 points.</span>
  <span class="c1">// `hookup` is a `Pipe` that passes our events through to the underlying `EventState` by-key.</span>
  <span class="c1">// Also see: `hookupKey` for a key-specific pipe.</span>
  <span class="k">val</span> <span class="nv">pointsByKey</span> <span class="k">=</span> <span class="nv">usersToCreate</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">k</span> <span class="k">=&gt;</span> <span class="nv">k</span><span class="o">.</span><span class="py">name</span> <span class="o">-&gt;</span> <span class="mi">5</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">addToEachUser</span> <span class="k">=</span> <span class="nv">pointsByKey</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">cache</span><span class="o">.</span><span class="py">hookup</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span>

  <span class="c1">// Gives us the result of loading in an existing user as well as the result of applying events to all of our new users.</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">initializeNewUsers</span>
    <span class="n">existing</span> <span class="k">&lt;-</span> <span class="n">getExistingUser</span>
    <span class="n">list</span> <span class="k">&lt;-</span> <span class="n">addToEachUser</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">(</span><span class="n">existing</span><span class="o">,</span> <span class="n">list</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">fullProgram</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res0: (Option[User], List[(String, Option[User])]) = (</span>
<span class="c1">//   Some(value = User(name = "ExistingUser", points = 3)),</span>
<span class="c1">//   List(</span>
<span class="c1">//     ("FirstUser", Some(value = User(name = "FirstUser", points = 5))),</span>
<span class="c1">//     ("SecondUser", Some(value = User(name = "SecondUser", points = 5))),</span>
<span class="c1">//     ("ThirdUser", Some(value = User(name = "ThirdUser", points = 5)))</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>As you would expect, these states in memory are only kept for the specified duration of 2 minutes.
After it has been 2 minutes since the last usage, it will try your “hydrator” function to retrieve a stream of events to recreate the current state for your entity.
Be sure, then, to have some kind of store for your events as they come in so that they can be properly retrieved.</p>
</section></div></div></div></div><script src="/fs2-es/highlight/highlight.pack.js"></script><script src="/fs2-es/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'fs2-es/community'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/fs2-es/js/search.js"></script><script src="/fs2-es/js/docs.js"></script></body></html>